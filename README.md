# Watering-esp32

Machine for watering several flowers. Autonomous, but with a WEB interface and sending messages to Telegram. Based on a esp32 family microcontrollers.

## Общее описание

Ещё одна поливалка на просторах github.  
Умеет опрашивать несколько аналоговых датчиков влажности и включать что-то для полива цветов.  
Умеет отправлять уведомления о состоявшемся поливе.  
Подсчитывает общий расход воды.

## Зачем это вообще нужно?

Каждый человек, который решил попробовать что такое паяльник и электроника должен пройти несколько этапов.

1) собрать моргалку светодиодом blink. Можно с помощью микроконтроллера, но это не путь истинного Джидая, лучше на транзисторах или, на худой конец, на NE555.
2) собрать "погодную станцию" подключив к arduino какой-нибудь датчик.
3) сделать часики.
4) сделать свой фонарик, "с блэк-джеком и шлюхами" (с) Futurama.
5) вспомнить о цветах и сделать наконец-то поливалку.
6) собрать какого-нибудь робота. Ну хотя-бы манипулятор. Чаще собирают машинки.

Если все эти этапы пройдены то, возможно, паяльник был куплен не зря :smiley:

Лично у меня пройдены 5 обязательных этапов, 4 из них выложены тут на github. Только отдельную погодную станцию не делал, а включил функционал в часики. И на самом деле всем, что я делаю, я реально пользуюсь. Бесполезных изделий нет. Кроме blink :smiley:

## Какие поливалки существуют?

Есть как минимум два варианта поиска на githab. По тегу watering и по тегу polivalka. По второму, к слову, больше толковых проектов.

Я пересмотрел почти все, на что потратил пол дня, и вот какие варианты существуют.

1) пустой проект. Иногда с readme или даже презентацией: "мы всем класом подумали и решили, что поливалка это круто!" Таких примерно четверть!
2) проект простой и самодостаточный. То есть совсем простой. Большая часть из них просто периодически включает что-то. Часто через delay() :smiley: Иногда там ещё есть подключение датчика влажности и включение не только через промежутки времени, но и если влажность упадёт. Это уже круто!
3) проекты похожие на пункт 2, но имеющие какой-то экран и позволяющие что-то настроить с кнопок. Это хорошо, но лучше всё-таки управлять удалённо.
4) проекты компаньоны. Микроконтроллер в таких проектах используется только как средство подключить датчики и исполнительные механизмы. А управляет логикой или условный HomeAssistant или непосредственно компьютер, стоящий рядом. И на самом деле это хорошее решение, которе позволяет настроить гибкую логику, получать разные графики и, если постараться, то управлять через облако. При чем, есть проект, где логика обсчитывается в MathLab, только непонятно зачем. Или прикрученный искусственный интеллект пытается предсказать влажность и обеспечить более равномерный полив. В общем, наверное за такими проектами будущее, но есть минус в том, что надо держать включенным какой-то компьютер - сервер, пусть даже это вариант RaspberryPie. Да и в общем такой сервер удорожает проект. Но если он уже есть в доме, то однозначно хорошая тема.
5) самодостаточные проекты, вроде моего. Их не так много, но они реально интересны. Я с удовольствием посмотрел с какими проблемами столкнулись авторы и как они их решали. Теперь, когда я уже немного набил шишек, разные решения становятся более понятны.

## С какими проблемами сталкивается человек решивший сделать поливалку?

На самом деле их много :smiley: Вот некоторые из них:

1) несмотря на то, что за один раз расходуется не так много воды, но на длинном участке времени это приличный объём. Так моя поливалка на 4 насоса и 4 прожорливых цветка израсходовала за 20 дней 11 литров. Больше ведра! Нужна большая тара. В одном из проектов использовался бак от кулера на 16 литров. Я взял большой тазик.
2) чтобы вода не вытекла сразу после первого включения насоса, нужно использовать или мембранный насос (но обычно они намного дороже и имеют питание 12В), или располагать емкость на другом уровне относительно цветка. Если это насос, то он должен быть ниже уровня цветов. Если это управляемый клапан, то наоборот выше уровня цветов. К стати, в случае с управляемым запорным клапаном можно подключится к водопроводу. Но этот риск на любителя.
3) трубка к насосу должна подходить по размеру. К примеру я взял первое попавшееся - 6/4мм. А носик насоса 7мм. Думаю понятно, что я устраивал садистские действия со шлангом, чтобы превратить 4мм внутреннего диаметра в 7мм. Хорошо, что он выдержал. Авторы которые рекомендуют 6/4 садисты которые сами попались на это и хотят, чтобы другие тоже мучились. С учётом цены на трубку ошибка может быть болезненной. [У меня такой насос.](https://ledplus.com.ua/ua/p1160030538-vodyanoj-nasos-pompa.html)(реальная производительность на 5В в три раза меньше, примерно 10мл/с).
4) цена вопроса определяется не стоимостью микроконтроллера, датчиков и насосов. А стоимостью шланга и проводов. Их надо много и в сумме они дороже электроники.
5) если цветов много, то длина шлангов и проводов должна быть разной, в зависимости от удаленности от емкости с водой.
6) в начале я купил реле для подключения насосов. Но они оказались настолько большими, тяжелыми и неудобными для подключения, что в итоге я использовал схему на полевых транзисторах. И в большинстве схем авторы пошли тем-же путём.
7) привлекает идея питать всё автономно, от аккумулятора. Но ток в момент старта насоса примерно 360мА, а во время работы 160мА. И это не включая потребления датчиков и самого микроконтроллера, даже если он будет большую часть времени спать. Кроме того, от 3.7В насосы работают совсем не резво. Ставить повышающий преобразователь - получить ещё больше потери емкости. И того, или надо собирать батарею приличной емкости, или не выпендриваться и работать от сети 230В. К стати, а как заряжать аккумуляторы? Бегать к ним с зарядкой? Впрочем один интересный по исполнению проект я нашел и автор утверждает, что он автономен 3 месяца...
8) датчик влажности надо брать емкостной, иначе он просто растворится за пару месяцев. Тоже касается и датчика уровня воды. В некоторых проектах применено интересное решение, при котором питание датчиков не постоянно, а только на момент опроса. Это требует дополнительных ног, что немного усложняет проект, тем не менее решение интересное и рабочее. Я же просто использовал емкостной датчик и вообще не ставил датчик уровня воды в баке.
9) топить насос или не топить? По правильному - топить. Но я, скептически посмотрев на качество герметизации решил не топить, пусть плавает в полу погруженном состоянии. Просто взял два куска пенопласта и стянул стяжками, а между ними зажались насосы. Шланги должны проходить так, чтобы не образовывались воздушные пробки.
10) показания аналоговых датчиков скачет как кардиограмма, что может приводить к неожиданному включению полива или наоборот к не включению. По этому нужен хотя-бы простейший фильтр показаний.
11) нет никакого общего правила как будет реагировать земля на полив и сколько надо поливать. В зависимости от грунта влажность может резко подскочить после полива или наоборот медленно подниматься. А у цветов в зависимости от времени года и температуры меняется потребность в воде. Хорошей практикой может быть небольшой полив утром, а в течении дня поддержание влажности на нужном уровне маленькими порциями. Если понадобится. Если влажность начала расти, надо уменьшить порцию утреннего полива.
12) застойная вода в открытом сосуде имеет свойство "цвести". Это нормально, в воздухе всегда летают споры одноклеточных водорослей. По этому вся эта конструкция требует или регулярной чистки или должна работать только относительно короткий период отпуска/командировки. Увы. Уменьшить скорость цветения можно закрыв ёмкость с водой от солнца и прикрыв крышкой.

## Особенности работы

Прошивка достаточно гибкая. В файле include/defines.h надо определить какие пины выделить на насосы, какие на датчики влажности, какой тип реле LOW или HIGH применён и сколько Вы хотите ячеек для расписания полива. Всё. Дальше вэб будет отображать именно Ваше количество насосов, датчиков, пунктов расписания.

Задание на полив задаётся расписанием. Вы там сами должны связать насосы, можно несколько, с одним из датчиков или с усреднённым показания для всех датчиков. Указать условие при котором включится полив и количество порций для этого полива. Можно вообще не привязывать к датчикам влажности, а поливать только по времени. Но летом в пик жары это не лучшее решение. Земля сохнет очень быстро.

Можно запустить полив в ручную или через телеграм. Но если расписание настроено приемлемо, то запускать полив руками не понадобится.

Полив осуществляется порциями. Размер одной порции в мл задаётся в основных настройках.

Для правильной работы насосов и датчиков существуют странички калибровки насосов и датчиков. Калибровка всех насосов происходит по одному, любому. Если насосы одинаковые, то разброс минимален. Калибровка датчиков влажности проходит дла каждого отдельно. У них большой разброс.

Есть потенциальная возможность расширять количество портов для подключения насосов, например через сдвиговый регистр или i2c плату расширения. Или комбинировать прямые порты и через расширитель. Но пока она не реализована, так как вариант с большим числом портов пока не реализован в железе.

При первом подключении будет поднята своя точка доступа WateringAP, надо подключится к ней, желательно с телефона, на предложение посетить страничку авторизации согласится и на открывшейся страничке выбрать свой wifi и указать пароль от него. Пароль сохранится даже после обновления прошивки. Если надо подключится к другой сети, то надо 5 раз быстро нажать на кнопку и опять поднимется точка доступа WateringAP. Если ничего менять не надо, ещё одно нажатие на кнопку вернёт всё назад.

Если поставили пароль и забыли :smiley: то надо 4 раза быстро нажать на кнопку после чего пароль временно отключится, можно зайти на web и в настройках указать новый пароль. Или убрать его. Одиночное нажатие на кнопку обратно включить текущий пароль.

Если просто нажать один раз на кнопку, то светодиод мигнёт три раза, чтобы показать, что железка жива. Если в этот момент шел полив, то он прервётся. По сути, одиночное нажатие работает как аварийная кнопка STOP для всех режимов.

## Сборка

Для сборки прошивки понадобится PlatformIO. В общем-то достаточно только его и командной строки, но удобнее установить VisualStudioCode и в нём расширение PlatformIO. И не забыть после прошивки загрузить файлы web сервера. Это можно сделать из VSCode, или через ftp скопировав на устройство все файлы из папки data.

Я не оформлял устройство в красивую коробку, так как мне нужна была работа, а не коммерческий экземпляр. Единственная рекомендация - используйте разъёмы для подключения к плате. Клемы проще и дешевле, но не удобно.

## Схема

Пока не нарисовал. Собирал всё на скорую руку, на глаз, тем не менее всё заработало. Хотя и с третьего раза. Сниму все номиналы и добавлю фактическую схему.

Я использовал Lolin 32 lite, так как в начале планировал резервное питание. Но по факту плата без сети не работает, только отсылает сообщения через GSM, когда пропадает и когда включается электричество. Но вот по уровню сигнала WiFi это самая крутая плата, с которой я имел дело. Неожиданно. Так как Lolin NodeMCU v2 наоборот худшая, точнее полный кошмар. А выглядят похоже, тоже без модуля и антенна разведена на плате. Рекомендую! Но вообще, для подобных самоделок, если не заморачиваться с аккумулятором, то лучше подходит ESP32C3 Super Mini. Про ESP8266 надо забывать.

## Фотографии

Общий вид с тазиком:  
![общий вид](https://github.com/SerhiiLe/Watering-esp32/blob/main/PXL_20250720_080338035.jpg)

Вид на плату, рядом с разъёмами распаяно "реле" на полевых транзисторах, но они smd и с другой стороны платы.
![плата](https://github.com/SerhiiLe/Watering-esp32/blob/main/PXL_20250720_080514097.jpg)

![home](https://github.com/SerhiiLe/Watering-esp32/blob/main/Watering-home.png)![scheduler](https://github.com/SerhiiLe/Watering-esp32/blob/main/Watering-scheduler.png)

## Планы

Актуальность таких проектов повышается к сезону отпусков и резко падает после. Но я постараюсь не забросить проект, а довести его до ума.
